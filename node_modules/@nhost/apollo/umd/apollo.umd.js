(function(S,N){typeof exports=="object"&&typeof module!="undefined"?N(exports,require("@apollo/client/core"),require("@apollo/client/link/context"),require("@apollo/client/link/subscriptions"),require("@apollo/client/utilities")):typeof define=="function"&&define.amd?define(["exports","@apollo/client/core","@apollo/client/link/context","@apollo/client/link/subscriptions","@apollo/client/utilities"],N):(S=typeof globalThis!="undefined"?globalThis:S||self,N(S["@nhost/apollo"]={},S["@apollo/client/core"],S["@apollo/client/link/context"],S["@apollo/client/link/subscriptions"],S["@apollo/client/utilities"]))})(this,function(S,N,ee,te,ne){"use strict";function h(e){return e===null?"null":Array.isArray(e)?"array":typeof e}function O(e){return h(e)==="object"}function re(e){return Array.isArray(e)&&e.length>0&&e.every(u=>"message"in u)}function Y(e,u){return e.length<124?e:u}const oe="graphql-transport-ws";var k;(function(e){e[e.InternalServerError=4500]="InternalServerError",e[e.InternalClientError=4005]="InternalClientError",e[e.BadRequest=4400]="BadRequest",e[e.BadResponse=4004]="BadResponse",e[e.Unauthorized=4401]="Unauthorized",e[e.Forbidden=4403]="Forbidden",e[e.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",e[e.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",e[e.ConnectionAcknowledgementTimeout=4504]="ConnectionAcknowledgementTimeout",e[e.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",e[e.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests"})(k||(k={}));var s;(function(e){e.ConnectionInit="connection_init",e.ConnectionAck="connection_ack",e.Ping="ping",e.Pong="pong",e.Subscribe="subscribe",e.Next="next",e.Error="error",e.Complete="complete"})(s||(s={}));function Z(e){if(!O(e))throw new Error(`Message is expected to be an object, but got ${h(e)}`);if(!e.type)throw new Error("Message is missing the 'type' property");if(typeof e.type!="string")throw new Error(`Message is expects the 'type' property to be a string, but got ${h(e.type)}`);switch(e.type){case s.ConnectionInit:case s.ConnectionAck:case s.Ping:case s.Pong:{if("payload"in e&&!O(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object or missing, but got "${e.payload}"`);break}case s.Subscribe:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${h(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!O(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${h(e.payload)}`);if(typeof e.payload.query!="string")throw new Error(`"${e.type}" message payload expects the 'query' property to be a string, but got ${h(e.payload.query)}`);if(e.payload.variables!=null&&!O(e.payload.variables))throw new Error(`"${e.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${h(e.payload.variables)}`);if(e.payload.operationName!=null&&h(e.payload.operationName)!=="string")throw new Error(`"${e.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${h(e.payload.operationName)}`);if(e.payload.extensions!=null&&!O(e.payload.extensions))throw new Error(`"${e.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${h(e.payload.extensions)}`);break}case s.Next:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${h(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!O(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${h(e.payload)}`);break}case s.Error:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${h(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!re(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(e.payload)}`);break}case s.Complete:{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${h(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);break}default:throw new Error(`Invalid message 'type' property "${e.type}"`)}return e}function ie(e,u){return Z(typeof e=="string"?JSON.parse(e,u):e)}function _(e,u){return Z(e),JSON.stringify(e,u)}function se(e){const{url:u,connectionParams:E,lazy:R=!0,onNonLazyError:I=console.error,lazyCloseTimeout:$=0,keepAlive:P=0,disablePong:g,connectionAckWaitTimeout:a=0,retryAttempts:x=5,retryWait:J=async function(p){let i=1e3;for(let r=0;r<p;r++)i*=2;await new Promise(r=>setTimeout(r,i+Math.floor(Math.random()*(3e3-300)+300)))},shouldRetry:G=C,isFatalConnectionProblem:q,on:t,webSocketImpl:B,generateID:Q=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,p=>{const i=Math.random()*16|0;return(p=="x"?i:i&3|8).toString(16)})},jsonMessageReplacer:j,jsonMessageReviver:V}=e;let w;if(B){if(!ce(B))throw new Error("Invalid WebSocket implementation provided");w=B}else typeof WebSocket!="undefined"?w=WebSocket:typeof global!="undefined"?w=global.WebSocket||global.MozWebSocket:typeof window!="undefined"&&(w=window.WebSocket||window.MozWebSocket);if(!w)throw new Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");const T=w,l=(()=>{const n=(()=>{const i={};return{on(r,c){return i[r]=c,()=>{delete i[r]}},emit(r){var c;"id"in r&&((c=i[r.id])===null||c===void 0||c.call(i,r))}}})(),p={connecting:t!=null&&t.connecting?[t.connecting]:[],opened:t!=null&&t.opened?[t.opened]:[],connected:t!=null&&t.connected?[t.connected]:[],ping:t!=null&&t.ping?[t.ping]:[],pong:t!=null&&t.pong?[t.pong]:[],message:t!=null&&t.message?[n.emit,t.message]:[n.emit],closed:t!=null&&t.closed?[t.closed]:[],error:t!=null&&t.error?[t.error]:[]};return{onMessage:n.on,on(i,r){const c=p[i];return c.push(r),()=>{c.splice(c.indexOf(r),1)}},emit(i,...r){for(const c of[...p[i]])c(...r)}}})();function K(n){const p=[l.on("error",i=>{p.forEach(r=>r()),n(i)}),l.on("closed",i=>{p.forEach(r=>r()),n(i)})]}let b,A=0,U,d=!1,y=0,M=!1;async function W(){clearTimeout(U);const[n,p]=await(b!=null?b:b=new Promise((c,D)=>(async()=>{if(d){if(await J(y),!A)return b=void 0,D({code:1e3,reason:"All Subscriptions Gone"});y++}l.emit("connecting");const o=new T(typeof u=="function"?await u():u,oe);let L,F;function X(){isFinite(P)&&P>0&&(clearTimeout(F),F=setTimeout(()=>{o.readyState===T.OPEN&&(o.send(_({type:s.Ping})),l.emit("ping",!1,void 0))},P))}K(f=>{b=void 0,clearTimeout(L),clearTimeout(F),D(f),C(f)&&f.code===4499&&(o.close(4499,"Terminated"),o.onerror=null,o.onclose=null)}),o.onerror=f=>l.emit("error",f),o.onclose=f=>l.emit("closed",f),o.onopen=async()=>{try{l.emit("opened",o);const f=typeof E=="function"?await E():E;if(o.readyState!==T.OPEN)return;o.send(_(f?{type:s.ConnectionInit,payload:f}:{type:s.ConnectionInit},j)),isFinite(a)&&a>0&&(L=setTimeout(()=>{o.close(k.ConnectionAcknowledgementTimeout,"Connection acknowledgement timeout")},a)),X()}catch(f){l.emit("error",f),o.close(k.InternalClientError,Y(f instanceof Error?f.message:new Error(f).message,"Internal client error"))}};let z=!1;o.onmessage=({data:f})=>{try{const m=ie(f,V);if(l.emit("message",m),m.type==="ping"||m.type==="pong"){l.emit(m.type,!0,m.payload),m.type==="pong"?X():g||(o.send(_(m.payload?{type:s.Pong,payload:m.payload}:{type:s.Pong})),l.emit("pong",!1,m.payload));return}if(z)return;if(m.type!==s.ConnectionAck)throw new Error(`First message cannot be of type ${m.type}`);clearTimeout(L),z=!0,l.emit("connected",o,m.payload),d=!1,y=0,c([o,new Promise((de,ue)=>K(ue))])}catch(m){o.onmessage=null,l.emit("error",m),o.close(k.BadResponse,Y(m instanceof Error?m.message:new Error(m).message,"Bad response"))}}})()));n.readyState===T.CLOSING&&await p;let i=()=>{};const r=new Promise(c=>i=c);return[n,i,Promise.race([r.then(()=>{if(!A){const c=()=>n.close(1e3,"Normal Closure");isFinite($)&&$>0?U=setTimeout(()=>{n.readyState===T.OPEN&&c()},$):c()}}),p])]}function v(n){if(C(n)&&(ae(n.code)||[k.InternalServerError,k.InternalClientError,k.BadRequest,k.BadResponse,k.Unauthorized,k.SubprotocolNotAcceptable,k.SubscriberAlreadyExists,k.TooManyInitialisationRequests].includes(n.code)))throw n;if(M)return!1;if(C(n)&&n.code===1e3)return A>0;if(!x||y>=x||!G(n)||q!=null&&q(n))throw n;return d=!0}return R||(async()=>{for(A++;;)try{const[,,n]=await W();await n}catch(n){try{if(!v(n))return}catch(p){return I==null?void 0:I(p)}}})(),{on:l.on,subscribe(n,p){const i=Q(n);let r=!1,c=!1,D=()=>{A--,r=!0};return(async()=>{for(A++;;)try{const[o,L,F]=await W();if(r)return L();const X=l.onMessage(i,z=>{switch(z.type){case s.Next:{p.next(z.payload);return}case s.Error:{c=!0,r=!0,p.error(z.payload),D();return}case s.Complete:{r=!0,D();return}}});o.send(_({id:i,type:s.Subscribe,payload:n},j)),D=()=>{!r&&o.readyState===T.OPEN&&o.send(_({id:i,type:s.Complete},j)),A--,r=!0,L()},await F.finally(X);return}catch(o){if(!v(o))return}})().then(()=>{c||p.complete()}).catch(o=>{p.error(o)}),()=>{r||D()}},async dispose(){if(M=!0,b){const[n]=await b;n.close(1e3,"Normal Closure")}},terminate(){b&&l.emit("closed",{code:4499,reason:"Terminated",wasClean:!1})}}}function C(e){return O(e)&&"code"in e&&"reason"in e}function ae(e){return[1e3,1001,1006,1005,1012,1013,1013].includes(e)?!1:e>=1e3&&e<=1999}function ce(e){return typeof e=="function"&&"constructor"in e&&"CLOSED"in e&&"CLOSING"in e&&"CONNECTING"in e&&"OPEN"in e}function le(e){let u=!1,E=()=>{u=!0},R=!1,I,$;const P=se({...e,on:{...e.on,error:g=>{var a,x;console.error(g),(x=(a=e.on)==null?void 0:a.error)==null||x.call(a,g),E()},ping:g=>{g||($=setTimeout(()=>{P.terminate(),E()},5e3))},pong:g=>{g&&clearTimeout($)},opened:g=>{var a,x;I=g,(x=(a=e.on)==null?void 0:a.opened)==null||x.call(a,I),R=!0,E=()=>{I.readyState===WebSocket.OPEN?I.close(4205,"Client Restart"):u=!0},u&&(u=!1,E())},closed:g=>{var a,x;(x=(a=e==null?void 0:e.on)==null?void 0:a.closed)==null||x.call(a,g),R=!1}}});return{...P,restart:()=>E(),isOpen:()=>R}}const H=typeof window!="undefined",pe=({nhost:e,graphqlUrl:u,headers:E={},publicRole:R="public",fetchPolicy:I,cache:$=new N.InMemoryCache,connectToDevTools:P=H&&process.env.NODE_ENV==="development",onError:g,link:a,generateLinks:x})=>{const J=u||(e==null?void 0:e.graphql.httpUrl);if(!J)throw Error("Can't initialize the Apollo Client: no backend Url has been provided");const G=J,q=e==null?void 0:e.auth.client.interpreter;let t=null;const B=()=>!!(t!=null&&t.value)&&!!(t!=null&&t.expiresAt)&&(t==null?void 0:t.expiresAt)>new Date,Q=()=>!t||B(),j=()=>{if(!Q())return new Promise(d=>{const y=setInterval(()=>{Q()&&(clearInterval(y),d(!0))},100)})},V=async()=>{await j();const d={...E,"Sec-WebSocket-Protocol":"graphql-ws"};return t?d.authorization=`Bearer ${t.value}`:d.role=R,d},w=H?le({url:G.startsWith("https")?G.replace(/^https/,"wss"):G.replace(/^http/,"ws"),shouldRetry:()=>!0,retryAttempts:100,retryWait:async d=>new Promise(W=>setTimeout(W,1e3*Math.pow(2,d)+Math.floor(Math.random()*3e3))),connectionParams:async()=>({headers:{...E,...await V()}})}):null,T=w?new te.GraphQLWsLink(w):null,l=ee.setContext(async(d,{headers:y})=>({headers:{...y,...await V()}})).concat(N.createHttpLink({uri:G})),K=T?N.split(({query:d})=>{const y=ne.getMainDefinition(d),{kind:M}=y;let W;return"operation"in y&&(W=y.operation),M==="OperationDefinition"&&W==="subscription"},T,l):l,b=[];g&&b.push(g),a&&b.push(a),b.push(K);const A=N.from(x?x(b):b),U=new N.ApolloClient({cache:$||new N.InMemoryCache,ssrMode:!H,defaultOptions:{watchQuery:{fetchPolicy:I}},connectToDevTools:P,link:A});return q==null||q.onTransition(async(d,y)=>{if(["SIGNOUT","SIGNED_IN","TOKEN_CHANGED"].includes(y.type)){if(y.type==="SIGNOUT"||y.type==="TOKEN_CHANGED"&&d.context.accessToken.value===null){t=null;try{await U.resetStore()}catch(M){console.error("Error resetting Apollo client cache"),console.error(M)}return}if(t=d.context.accessToken,!H||!(w!=null&&w.isOpen()))return;w==null||w.restart()}}),U};S.createApolloClient=pe,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=apollo.umd.js.map
