(function(t,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("@apollo/client"),require("@nhost/react"),require("react/jsx-runtime"),require("react"),require("@apollo/client/core"),require("@apollo/client/link/context"),require("@apollo/client/link/subscriptions"),require("@apollo/client/utilities"),require("graphql-ws")):typeof define=="function"&&define.amd?define(["exports","@apollo/client","@nhost/react","react/jsx-runtime","react","@apollo/client/core","@apollo/client/link/context","@apollo/client/link/subscriptions","@apollo/client/utilities","graphql-ws"],p):(t=typeof globalThis!="undefined"?globalThis:t||self,p(t["@nhost/react-apollo"]={},t["@apollo/client"],t["@nhost/react"],t._jsx,t.React,t["@apollo/client/core"],t["@apollo/client/link/context"],t["@apollo/client/link/subscriptions"],t["@apollo/client/utilities"],t["graphql-ws"]))})(this,function(t,p,T,I,q,h,M,b,j,G){"use strict";function L(n,e){const o=T.useAuthenticated(),c={...e,skip:(e==null?void 0:e.skip)||!o};return p.useQuery(n,c)}function Q(n,e){const o=T.useAuthenticated(),c={...e,skip:(e==null?void 0:e.skip)||!o};return p.useSubscription(n,c)}function U(n){let e=!1,o=()=>{e=!0},c=!1,d,v;const k=G.createClient({...n,on:{...n.on,error:l=>{var r,u;console.error(l),(u=(r=n.on)==null?void 0:r.error)==null||u.call(r,l),o()},ping:l=>{l||(v=setTimeout(()=>{k.terminate(),o()},5e3))},pong:l=>{l&&clearTimeout(v)},opened:l=>{var r,u;d=l,(u=(r=n.on)==null?void 0:r.opened)==null||u.call(r,d),c=!0,o=()=>{d.readyState===WebSocket.OPEN?d.close(4205,"Client Restart"):e=!0},e&&(e=!1,o())},closed:l=>{var r,u;(u=(r=n==null?void 0:n.on)==null?void 0:r.closed)==null||u.call(r,l),c=!1}}});return{...k,restart:()=>o(),isOpen:()=>c}}const w=typeof window!="undefined",W=({nhost:n,graphqlUrl:e,headers:o={},publicRole:c="public",fetchPolicy:d,cache:v=new h.InMemoryCache,connectToDevTools:k=w&&process.env.NODE_ENV==="development",onError:l,link:r,generateLinks:u})=>{const S=e||(n==null?void 0:n.graphql.httpUrl);if(!S)throw Error("Can't initialize the Apollo Client: no backend Url has been provided");const A=S,C=n==null?void 0:n.auth.client.interpreter;let a=null;const R=()=>!!(a!=null&&a.value)&&!!(a!=null&&a.expiresAt)&&(a==null?void 0:a.expiresAt)>new Date,N=()=>!a||R(),H=()=>{if(!N())return new Promise(i=>{const s=setInterval(()=>{N()&&(clearInterval(s),i(!0))},100)})},O=async()=>{await H();const i={...o,"Sec-WebSocket-Protocol":"graphql-ws"};return a?i.authorization=`Bearer ${a.value}`:i.role=c,i},f=w?U({url:A.startsWith("https")?A.replace(/^https/,"wss"):A.replace(/^http/,"ws"),shouldRetry:()=>!0,retryAttempts:100,retryWait:async i=>new Promise(s=>setTimeout(s,1e3*Math.pow(2,i)+Math.floor(Math.random()*3e3))),connectionParams:async()=>({headers:{...o,...await O()}})}):null,x=f?new b.GraphQLWsLink(f):null,E=M.setContext(async(i,{headers:s})=>({headers:{...s,...await O()}})).concat(h.createHttpLink({uri:A})),z=x?h.split(({query:i})=>{const s=j.getMainDefinition(i),{kind:m}=s;let D;return"operation"in s&&(D=s.operation),m==="OperationDefinition"&&D==="subscription"},x,E):E,y=[];l&&y.push(l),r&&y.push(r),y.push(z);const K=h.from(u?u(y):y),P=new h.ApolloClient({cache:v||new h.InMemoryCache,ssrMode:!w,defaultOptions:{watchQuery:{fetchPolicy:d}},connectToDevTools:k,link:K});return C==null||C.onTransition(async(i,s)=>{if(["SIGNOUT","SIGNED_IN","TOKEN_CHANGED"].includes(s.type)){if(s.type==="SIGNOUT"||s.type==="TOKEN_CHANGED"&&i.context.accessToken.value===null){a=null;try{await P.resetStore()}catch(m){console.error("Error resetting Apollo client cache"),console.error(m)}return}if(a=i.context.accessToken,!w||!(f!=null&&f.isOpen()))return;f==null||f.restart()}}),P},_=new p.ApolloClient({cache:new p.InMemoryCache}),g=({children:n,...e})=>{const[o,c]=q.useState();return q.useEffect(()=>{o||c(W(e))},[o,e]),I.jsx(p.ApolloProvider,{client:o||_,children:n})};t.NhostApolloProvider=g,t.useAuthQuery=L,t.useAuthSubscription=Q,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=react-apollo.umd.js.map
