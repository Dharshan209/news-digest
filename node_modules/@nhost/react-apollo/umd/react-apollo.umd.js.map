{"version":3,"file":"react-apollo.umd.js","sources":["../src/hooks.tsx","../../apollo/dist/index.esm.js","../src/provider.tsx"],"sourcesContent":["import {\n  DocumentNode,\n  OperationVariables,\n  QueryHookOptions,\n  SubscriptionHookOptions,\n  TypedDocumentNode,\n  useQuery,\n  useSubscription\n} from '@apollo/client'\nimport { useAuthenticated } from '@nhost/react'\n\nexport function useAuthQuery<\n  TData = any,\n  TVariables extends OperationVariables = OperationVariables\n>(\n  query: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: QueryHookOptions<TData, TVariables>\n) {\n  const isAuthenticated = useAuthenticated()\n  const newOptions = { ...options, skip: options?.skip || !isAuthenticated }\n  return useQuery(query, newOptions)\n}\n\nexport function useAuthSubscription<\n  TData = any,\n  TVariables extends OperationVariables = OperationVariables\n>(\n  subscription: DocumentNode | TypedDocumentNode<TData, TVariables>,\n  options?: SubscriptionHookOptions<TData, TVariables>\n) {\n  const isAuthenticated = useAuthenticated()\n  const newOptions: SubscriptionHookOptions<TData, TVariables> = {\n    ...options,\n    skip: options?.skip || !isAuthenticated\n  }\n\n  return useSubscription(subscription, newOptions)\n}\n\n// TODO consider other hooks\n/*\n- useAuthLazyQuery\n- useAuthMutation\n- useRoleQuery\n- useRoleLazyQuery\n- useRoleMutation\n- useRoleSubscription\n*/\n","import { createHttpLink as g, split as G, from as M, ApolloClient as H, InMemoryCache as C } from \"@apollo/client/core\";\nimport { setContext as P } from \"@apollo/client/link/context\";\nimport { GraphQLWsLink as U } from \"@apollo/client/link/subscriptions\";\nimport { getMainDefinition as W } from \"@apollo/client/utilities\";\nimport { createClient as _ } from \"graphql-ws\";\nfunction L(t) {\n  let c = !1, l = () => {\n    c = !0;\n  }, p = !1, u, d;\n  const m = _({\n    ...t,\n    on: {\n      ...t.on,\n      error: (n) => {\n        var e, a;\n        console.error(n), (a = (e = t.on) == null ? void 0 : e.error) == null || a.call(e, n), l();\n      },\n      ping: (n) => {\n        n || (d = setTimeout(() => {\n          m.terminate(), l();\n        }, 5e3));\n      },\n      pong: (n) => {\n        n && clearTimeout(d);\n      },\n      opened: (n) => {\n        var e, a;\n        u = n, (a = (e = t.on) == null ? void 0 : e.opened) == null || a.call(e, u), p = !0, l = () => {\n          u.readyState === WebSocket.OPEN ? u.close(4205, \"Client Restart\") : c = !0;\n        }, c && (c = !1, l());\n      },\n      closed: (n) => {\n        var e, a;\n        (a = (e = t == null ? void 0 : t.on) == null ? void 0 : e.closed) == null || a.call(e, n), p = !1;\n      }\n    }\n  });\n  return {\n    ...m,\n    restart: () => l(),\n    isOpen: () => p\n  };\n}\nconst O = typeof window != \"undefined\", J = ({\n  nhost: t,\n  graphqlUrl: c,\n  headers: l = {},\n  publicRole: p = \"public\",\n  fetchPolicy: u,\n  cache: d = new C(),\n  connectToDevTools: m = O && process.env.NODE_ENV === \"development\",\n  onError: n,\n  link: e,\n  generateLinks: a\n}) => {\n  const k = c || (t == null ? void 0 : t.graphql.httpUrl);\n  if (!k)\n    throw Error(\"Can't initialize the Apollo Client: no backend Url has been provided\");\n  const h = k, N = t == null ? void 0 : t.auth.client.interpreter;\n  let r = null;\n  const S = () => !!(r != null && r.value) && !!(r != null && r.expiresAt) && (r == null ? void 0 : r.expiresAt) > /* @__PURE__ */ new Date(), b = () => !r || S(), T = () => {\n    if (!b())\n      return new Promise((i) => {\n        const o = setInterval(() => {\n          b() && (clearInterval(o), i(!0));\n        }, 100);\n      });\n  }, A = async () => {\n    await T();\n    const i = {\n      ...l,\n      \"Sec-WebSocket-Protocol\": \"graphql-ws\"\n    };\n    return r ? i.authorization = `Bearer ${r.value}` : i.role = p, i;\n  }, s = O ? L({\n    url: h.startsWith(\"https\") ? h.replace(/^https/, \"wss\") : h.replace(/^http/, \"ws\"),\n    shouldRetry: () => !0,\n    retryAttempts: 100,\n    retryWait: async (i) => new Promise(\n      (y) => setTimeout(\n        y,\n        1e3 * Math.pow(2, i) + Math.floor(Math.random() * 3e3)\n      )\n    ),\n    connectionParams: async () => ({\n      headers: {\n        ...l,\n        ...await A()\n      }\n    })\n  }) : null, D = s ? new U(s) : null, E = P(async (i, { headers: o }) => ({\n    headers: {\n      ...o,\n      ...await A()\n    }\n  })).concat(g({ uri: h })), v = D ? G(\n    ({ query: i }) => {\n      const o = W(i), { kind: w } = o;\n      let y;\n      return \"operation\" in o && (y = o.operation), w === \"OperationDefinition\" && y === \"subscription\";\n    },\n    D,\n    E\n  ) : E, f = [];\n  n && f.push(n), e && f.push(e), f.push(v);\n  const I = M(a ? a(f) : f), x = new H({\n    cache: d || new C(),\n    ssrMode: !O,\n    defaultOptions: {\n      watchQuery: {\n        fetchPolicy: u\n      }\n    },\n    connectToDevTools: m,\n    link: I\n  });\n  return N == null || N.onTransition(async (i, o) => {\n    if ([\"SIGNOUT\", \"SIGNED_IN\", \"TOKEN_CHANGED\"].includes(o.type)) {\n      if (o.type === \"SIGNOUT\" || o.type === \"TOKEN_CHANGED\" && i.context.accessToken.value === null) {\n        r = null;\n        try {\n          await x.resetStore();\n        } catch (w) {\n          console.error(\"Error resetting Apollo client cache\"), console.error(w);\n        }\n        return;\n      }\n      if (r = i.context.accessToken, !O || !(s != null && s.isOpen()))\n        return;\n      s == null || s.restart();\n    }\n  }), x;\n};\nexport {\n  J as createApolloClient\n};\n//# sourceMappingURL=index.esm.js.map\n","import React, { PropsWithChildren, useEffect, useState } from 'react'\n\nimport { ApolloClient, ApolloProvider, InMemoryCache } from '@apollo/client'\nimport { createApolloClient, NhostApolloClientOptions } from '@nhost/apollo'\n\n// This is needed because ApolloProvider can't be rendered without a client. To be able to render\n// the children without our client, we need an ApolloProvider because of potential underlying\n// useQuery hooks in customer applications. This way ApolloProvider and children can be rendered.\nconst mockApolloClient = new ApolloClient({ cache: new InMemoryCache() })\n\nexport const NhostApolloProvider: React.FC<PropsWithChildren<NhostApolloClientOptions>> = ({\n  children,\n  ...options\n}) => {\n  // * See https://github.com/nhost/nhost/pull/214#pullrequestreview-889730478\n  const [client, setClient] = useState<ReturnType<typeof createApolloClient>>()\n\n  // Note: Because we're using XState under the hood, we need to make sure to start the interpreter\n  // on the client side when the component is mounted. This is why we're using `useState` and\n  // `useEffect`.\n  useEffect(() => {\n    if (!client) {\n      setClient(createApolloClient(options))\n    }\n  }, [client, options])\n\n  return <ApolloProvider client={client || mockApolloClient}>{children}</ApolloProvider>\n}\n"],"names":["useAuthQuery","query","options","isAuthenticated","useAuthenticated","newOptions","useQuery","useAuthSubscription","subscription","useSubscription","L","t","c","l","p","u","d","m","_","n","e","a","O","J","C","k","h","N","r","S","b","T","o","A","s","y","D","U","P","g","v","G","W","w","f","I","M","x","H","mockApolloClient","ApolloClient","InMemoryCache","NhostApolloProvider","children","client","setClient","useState","useEffect","createApolloClient","jsx","ApolloProvider"],"mappings":"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"}